---
import Layout from '../../layouts/Layout.astro';
import Navigation from '../../components/Navigation.astro';
import Footer from '../../components/Footer.astro';
import { createServerSupabaseClient } from '../../lib/supabase/server';

const { user } = Astro.locals;

// Get rejection reason if available
let rejectionReason: string | null = null;
if (user) {
  const supabase = createServerSupabaseClient(Astro.cookies);
  const { data } = await supabase
    .from('user_logins')
    .select('rejection_reason')
    .eq('auth_id', user.id)
    .single();

  rejectionReason = data?.rejection_reason || null;
}
---

<Layout title="Access Denied">
  <Navigation currentPath="/auth/rejected" />

  <main class="pt-20 min-h-screen bg-gradient-to-b from-[--color-cream] to-[--color-linen]">
    <div class="max-w-lg mx-auto px-4 sm:px-6 py-16 md:py-24">
      <!-- Status Card -->
      <div class="card p-8 text-center">
        <!-- Rejected Icon -->
        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-red-100 flex items-center justify-center">
          <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>

        <!-- Status Badge -->
        <span class="inline-block px-4 py-1 rounded-full text-sm font-medium bg-red-100 text-red-600 mb-4">
          Account Not Approved
        </span>

        <h1 class="font-heading text-2xl md:text-3xl text-[--color-espresso] mb-4">
          Access Not Granted
        </h1>

        <p class="text-[--color-text-muted] mb-6">
          We're sorry, but your account request has not been approved at this time.
        </p>

        {rejectionReason && (
          <div class="p-4 rounded-lg bg-red-50 border border-red-200 mb-6 text-left">
            <p class="text-sm font-medium text-red-800 mb-1">Reason:</p>
            <p class="text-sm text-red-700">{rejectionReason}</p>
          </div>
        )}

        {user?.email && (
          <div class="p-4 rounded-lg bg-[--color-linen] mb-6">
            <p class="text-sm text-[--color-cocoa]">
              <span class="font-medium">Account:</span><br />
              {user.email}
            </p>
          </div>
        )}

        <!-- Contact Info -->
        <div class="text-left mt-8 p-4 rounded-lg bg-[--color-cream] border border-[--color-border]">
          <h3 class="font-heading text-lg text-[--color-espresso] mb-3">Need Help?</h3>
          <p class="text-sm text-[--color-cocoa]">
            If you believe this is an error or would like to appeal this decision, please contact our support team for assistance.
          </p>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3 justify-center mt-8">
          <a href="/auth/logout" class="btn btn-secondary">
            Sign Out
          </a>
          <a href="/" class="btn btn-ghost">
            Back to Home
          </a>
        </div>
      </div>
    </div>
  </main>

  <Footer />
</Layout>
